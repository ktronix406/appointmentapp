<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Scheduling</title>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar 6.1.15 JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <!-- Bootstrap CSS for Modal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<style>
    #calendar {
        margin: 40px;
    }

    #contextMenu {
        display: none;
        position: absolute;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ccc;
    }

    .list-group-item {
        cursor: pointer;
    }
</style>

<body>
    <div class="container">
        <h1 class="text-center my-4">Appointment Scheduling</h1>

        <div id="calendar" class="calendar"></div>

        <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="appointmentModalLabel">Create Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <form id="appointment-form" action="/schedule" method="POST">
                            <input type="hidden" name="start_time" id="appointmentStartTime">

                            <div class="row">
                                <!-- Customer Information -->
                                <div class="col-md-6 mb-3">
                                    <label for="customerFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="customerFirstName"
                                        name="customer_first_name" placeholder="Enter first name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="customerLastName"
                                        name="customer_last_name" placeholder="Enter last name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="customerPhone" name="customer_phone"
                                        placeholder="(999) 999-9999" required>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Vehicle Information -->
                                <div class="col-md-4 mb-3">
                                    <label for="vehicleYear" class="form-label">Vehicle Year</label>
                                    <input type="text" class="form-control" id="vehicleYear" name="vehicle_year"
                                        placeholder="Enter vehicle year" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="vehicleMake" class="form-label">Vehicle Make</label>
                                    <input type="text" class="form-control" id="vehicleMake" name="vehicle_make"
                                        placeholder="Enter vehicle make" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="vehicleModel" class="form-label">Vehicle Model</label>
                                    <input type="text" class="form-control" id="vehicleModel" name="vehicle_model"
                                        placeholder="Enter vehicle model" required>
                                </div>
                            </div>

                            <!-- Product Details Section -->
                            <div id="product-details-section">
                                <div class="row mb-3 product-entry">
                                    <div class="col-md-6">
                                        <label for="productName" class="form-label">Product Name</label>
                                        <input type="text" class="form-control" name="product_name[]"
                                            placeholder="Enter product name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="productPrice" class="form-label">Product Price</label>
                                        <input type="text" class="form-control" name="product_price[]"
                                            placeholder="Enter product price (informational only)">
                                    </div>
                                    <div class="col-md-12 text-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-product">Remove
                                            Product</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-secondary btn-sm" id="addProduct">Add Another
                                        Product</button>
                                </div>
                            </div>

                            <!-- Installation Type and Duration -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="installationType" class="form-label">Installation Type</label>
                                    <select class="form-select" id="installationType" name="installation_type" required>
                                        <option value="standard">Standard Installation</option>
                                        <option value="custom">Custom Installation</option>
                                        <option value="check">Check</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="duration" class="form-label">Duration</label>
                                    <select class="form-select" id="duration" name="duration" required>
                                        <option value="1">1 Hour</option>
                                        <option value="2">2 Hours</option>
                                        <option value="3">3 Hours</option>
                                        <option value="4">4 Hours</option>
                                        <option value="5">5 Hours</option>
                                        <option value="6">6 Hours</option>
                                        <option value="8">All Day</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Installation Details Section -->
                            <div id="installation-details-section">
                                <div class="row mb-3 installation-entry">
                                    <div class="col-md-6">
                                        <label for="installationJob" class="form-label">Installation Job</label>
                                        <input type="text" class="form-control" name="installation_job[]"
                                            placeholder="Enter installation job details" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="installationPrice" class="form-label">Installation Price</label>
                                        <input type="text" class="form-control" name="installation_price[]"
                                            placeholder="Enter installation price" required>
                                    </div>
                                    <div class="col-md-12 text-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-installation">Remove
                                            Installation</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-secondary btn-sm" id="addInstallation">Add
                                        Another Installation Job</button>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Additional Notes -->
                                <div class="col-md-12 mb-3">
                                    <label for="notes" class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="notes" name="notes"
                                        placeholder="Enter additional notes" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary w-100">Schedule Appointment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="contextMenu">
            <ul class="list-group">
                <li class="list-group-item" id="editEvent">Edit</li>
                <li class="list-group-item text-danger" id="deleteEvent">Delete</li>
            </ul>
        </div>

        <script>

document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        themeSystem: 'bootstrap',
        initialView: 'timeGridDay',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        slotMinTime: '08:00:00',
        slotMaxTime: '18:00:00',
        slotDuration: '01:00:00',
        expandRows: true,
        selectable: true,
        selectMirror: true,
        editable: true,  // Allows editing, dragging, and resizing
        events: JSON.parse('{{ events|tojson|safe }}'), // Load events into FullCalendar

        select: function (info) {
            // Open the modal for creating a new appointment
            var modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
            document.getElementById('appointmentStartTime').value = info.startStr;
            document.getElementById('appointment-form').reset(); // Reset form fields
            modal.show();
        },

        eventDidMount: function(info) {
            // Add a data attribute to link the event element with its ID
            info.el.setAttribute('data-event-id', info.event.id);
        },

        eventClick: function (info) {
            // Prevent default click behavior
            info.jsEvent.preventDefault();
        },

        eventDrop: function (info) {  // Handles event moving
            moveAppointment(info.event);
        },

        eventResize: function (info) {  // Handles event resizing
            moveAppointment(info.event);
        }
    });
    calendar.render();

    // Prevent the default right-click menu on calendar events
    calendarEl.addEventListener('contextmenu', function (event) {
        event.preventDefault();
    });

    // Handle right-click on an event to open the custom context menu
    calendarEl.addEventListener('contextmenu', function (jsEvent) {
        var eventElement = jsEvent.target.closest('.fc-event'); // Find the event element
        if (eventElement) {
            var eventId = eventElement.getAttribute('data-event-id'); // Get the event ID
            var event = calendar.getEventById(eventId); // Get the event object by ID
            if (event) {
                openContextMenu(jsEvent, event);
            }
        }
    });

    // Function to handle the context menu display
    function openContextMenu(jsEvent, event) {
        var contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'block';
        contextMenu.style.left = jsEvent.pageX + 'px';
        contextMenu.style.top = jsEvent.pageY + 'px';

        document.getElementById('editEvent').onclick = function () {
            editAppointment(event);
        };
        document.getElementById('deleteEvent').onclick = function () {
            deleteAppointment(event);
        };

        jsEvent.preventDefault(); // Prevent default right-click menu
    }

    // Hide the context menu when clicking outside
    document.addEventListener('click', function () {
        var contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
    });

    function deleteAppointment(event) {
        if (confirm('Are you sure you want to delete this appointment?')) {
            fetch(`/appointment/delete/${event.id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then(response => {
                if (response.ok) {
                    event.remove();
                    alert('Appointment deleted successfully.');
                } else {
                    alert('Failed to delete the appointment.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('There was an error deleting the appointment.');
            });
        }
    }

    function editAppointment(event) {
        var modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        document.getElementById('appointmentStartTime').value = event.start.toISOString().slice(0, 19);
        // Fill other fields as necessary from the event object
        document.getElementById('customerFirstName').value = event.extendedProps.customer_first_name || '';
        document.getElementById('customerLastName').value = event.extendedProps.customer_last_name || '';
        document.getElementById('customerPhone').value = event.extendedProps.customer_phone || '';
        document.getElementById('vehicleYear').value = event.extendedProps.vehicle_year || '';
        document.getElementById('vehicleMake').value = event.extendedProps.vehicle_make || '';
        document.getElementById('vehicleModel').value = event.extendedProps.vehicle_model || '';
        document.getElementById('installationType').value = event.extendedProps.installation_type || '';
        document.getElementById('duration').value = event.extendedProps.duration || '';
        // Populate product details if available
        populateProductDetails(event.extendedProps.products);

        modal.show();

        // Handle saving the changes in the modal
        document.getElementById('appointment-form').onsubmit = function (e) {
            e.preventDefault();
            let formData = new FormData(this);

            fetch(`/appointment/edit/${event.id}`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    event.setProp('title', formData.get('customer_first_name') + ' - ' + formData.get('product_name[]'));
                    event.setStart(document.getElementById('appointmentStartTime').value);
                    let duration = formData.get('duration');
                    let endTime = new Date(new Date(event.start).getTime() + duration * 60 * 60 * 1000);
                    event.setEnd(endTime.toISOString());
                    alert('Appointment updated successfully.');
                } else {
                    alert('Failed to update the appointment.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('There was an error updating the appointment.');
            });
            modal.hide();
        };
    }

    function moveAppointment(event) {
        fetch(`/appointment/move/${event.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `start_time=${encodeURIComponent(event.start.toISOString())}`
        }).then(response => {
            if (response.ok) {
                alert('Appointment moved successfully.');
            } else {
                alert('Failed to move the appointment.');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('There was an error moving the appointment.');
        });
    }

    function populateProductDetails(products) {
        const productSection = document.getElementById('product-details-section');
        productSection.innerHTML = ''; // Clear existing product entries

        if (products) {
            products.forEach((product, index) => {
                const productEntry = document.createElement('div');
                productEntry.className = 'row mb-3 product-entry';

                const productNameDiv = document.createElement('div');
                productNameDiv.className = 'col-md-6';
                const productNameInput = document.createElement('input');
                productNameInput.type = 'text';
                productNameInput.name = 'product_name[]';
                productNameInput.placeholder = 'Enter product name';
                productNameInput.className = 'form-control';
                productNameInput.value = product.name;
                productNameDiv.appendChild(productNameInput);

                const productPriceDiv = document.createElement('div');
                productPriceDiv.className = 'col-md-6';
                const productPriceInput = document.createElement('input');
                productPriceInput.type = 'text';
                productPriceInput.name = 'product_price[]';
                productPriceInput.placeholder = 'Enter product price (informational only)';
                productPriceInput.className = 'form-control';
                productPriceInput.value = product.price;
                productPriceDiv.appendChild(productPriceInput);

                const removeButtonDiv = document.createElement('div');
                removeButtonDiv.className = 'col-md-12 text-end';
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn btn-danger btn-sm remove-product';
                removeButton.textContent = 'Remove Product';
                removeButtonDiv.appendChild(removeButton);

                productEntry.appendChild(productNameDiv);
                productEntry.appendChild(productPriceDiv);
                productEntry.appendChild(removeButtonDiv);

                productSection.appendChild(productEntry);

                removeButton.addEventListener('click', function () {
                    productEntry.remove();
                });
            });
        }
    }
});

            // Phone number formatting
            document.getElementById('customerPhone').addEventListener('input', function (e) {
                var x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });

            // Add product functionality
            document.getElementById('addProduct').addEventListener('click', function () {
                var productContainer = document.createElement('div');
                productContainer.className = 'row mb-3 product-entry';

                var productNameDiv = document.createElement('div');
                productNameDiv.className = 'col-md-6';
                var productNameInput = document.createElement('input');
                productNameInput.type = 'text';
                productNameInput.name = 'product_name[]';
                productNameInput.placeholder = 'Enter product name';
                productNameInput.className = 'form-control';
                productNameDiv.appendChild(productNameInput);

                var productPriceDiv = document.createElement('div');
                productPriceDiv.className = 'col-md-6';
                var productPriceInput = document.createElement('input');
                productPriceInput.type = 'text';
                productPriceInput.name = 'product_price[]';
                productPriceInput.placeholder = 'Enter product price (informational only)';
                productPriceInput.className = 'form-control';
                productPriceDiv.appendChild(productPriceInput);

                var removeButtonDiv = document.createElement('div');
                removeButtonDiv.className = 'col-md-12 text-end';
                var removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn btn-danger btn-sm remove-product';
                removeButton.textContent = 'Remove Product';
                removeButtonDiv.appendChild(removeButton);

                productContainer.appendChild(productNameDiv);
                productContainer.appendChild(productPriceDiv);
                productContainer.appendChild(removeButtonDiv);

                document.getElementById('product-details-section').appendChild(productContainer);

                removeButton.addEventListener('click', function () {
                    productContainer.remove();
                });
            });

            // Add installation job functionality
            document.getElementById('addInstallation').addEventListener('click', function () {
                var installationContainer = document.createElement('div');
                installationContainer.className = 'row mb-3 installation-entry';

                var installationJobDiv = document.createElement('div');
                installationJobDiv.className = 'col-md-6';
                var installationJobInput = document.createElement('input');
                installationJobInput.type = 'text';
                installationJobInput.name = 'installation_job[]';
                installationJobInput.placeholder = 'Enter installation job details';
                installationJobInput.className = 'form-control';
                installationJobDiv.appendChild(installationJobInput);

                var installationPriceDiv = document.createElement('div');
                installationPriceDiv.className = 'col-md-6';
                var installationPriceInput = document.createElement('input');
                installationPriceInput.type = 'text';
                installationPriceInput.name = 'installation_price[]';
                installationPriceInput.placeholder = 'Enter installation price';
                installationPriceInput.className = 'form-control';
                installationPriceDiv.appendChild(installationPriceInput);

                var removeButtonDiv = document.createElement('div');
                removeButtonDiv.className = 'col-md-12 text-end';
                var removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn btn-danger btn-sm remove-installation';
                removeButton.textContent = 'Remove Installation';
                removeButtonDiv.appendChild(removeButton);

                installationContainer.appendChild(installationJobDiv);
                installationContainer.appendChild(installationPriceDiv);
                installationContainer.appendChild(removeButtonDiv);

                document.getElementById('installation-details-section').appendChild(installationContainer);

                removeButton.addEventListener('click', function () {
                    installationContainer.remove();
                });
            });

            // Remove product functionality for existing products
            document.querySelectorAll('.remove-product').forEach(button => {
                button.addEventListener('click', function () {
                    button.closest('.product-entry').remove();
                });
            });

            // Remove installation functionality for existing installations
            document.querySelectorAll('.remove-installation').forEach(button => {
                button.addEventListener('click', function () {
                    button.closest('.installation-entry').remove();
                });
            });
        </script>
    </div>
</body>

</html>
